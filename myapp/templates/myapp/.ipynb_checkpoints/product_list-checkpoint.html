{% extends 'myapp/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Product List - Cosmetic Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-cubes me-2"></i>My Cosmetics</h1>
    <a href="{% url 'myapp:product_add' %}" class="btn btn-primary">
        <i class="fas fa-plus me-1"></i> Add New Product
    </a>
</div>

<!-- 动态统计卡片 - 真实数据 -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stats-card good">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Good</h5>
                        <h2 class="card-text">{{ good_count }}</h2>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stats-card soon">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Expiring Soon</h5>
                        <h2 class="card-text">{{ soon_count }}</h2>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stats-card urgent">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Urgent</h5>
                        <h2 class="card-text">{{ urgent_count }}</h2>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stats-card expired">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Expired</h5>
                        <h2 class="card-text">{{ expired_count }}</h2>
                    </div>
                    <div class="text-danger">
                        <i class="fas fa-times-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 后端筛选表单 - 保留这个真实的筛选功能 -->
<div class="card mb-4">
    <div class="card-body">
        <form method="get" action="{% url 'myapp:product_list' %}" id="filter-form">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" 
                               placeholder="Search by product name, brand..." 
                               name="search" value="{{ current_search }}">
                        <button class="btn btn-outline-primary" type="submit">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="status" onchange="this.form.submit()">
                        <option value="">All Statuses</option>
                        <option value="good" {% if current_status == 'good' %}selected{% endif %}>Good</option>
                        <option value="soon" {% if current_status == 'soon' %}selected{% endif %}>Expiring Soon</option>
                        <option value="urgent" {% if current_status == 'urgent' %}selected{% endif %}>Urgent</option>
                        <option value="expired" {% if current_status == 'expired' %}selected{% endif %}>Expired</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="category" onchange="this.form.submit()">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" 
                                {% if current_category == category.id|stringformat:"i" %}selected{% endif %}>
                            {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 筛选结果提示 -->
{% if current_status or current_category or current_search %}
<div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
    <div>
        <strong>Filter Applied:</strong>
        {% if current_status %}Status: {{ current_status|title }}{% endif %}
        {% if current_category %} | Category: {% for cat in categories %}{% if cat.id == current_category|add:0 %}{{ cat.name }}{% endif %}{% endfor %}{% endif %}
        {% if current_search %} | Search: "{{ current_search }}"{% endif %}
        | Showing {{ products|length }} of {{ total_count }} products
    </div>
    <a href="{% url 'myapp:product_list' %}" class="btn btn-sm btn-outline-secondary">
        <i class="fas fa-times"></i> Clear Filters
    </a>
</div>
{% endif %}

<!-- Product List -->
{% if products %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-light">
            <tr>
                <th>Product Name</th>
                <th>Brand</th>
                <th>Category</th>
                <th>Expiration Date</th>
                <th>Status</th>
                <th>Days Left</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr class="align-middle">
                <td>
                    <strong>{{ product.name }}</strong>
                    {% if product.shade %}
                    <br><small class="text-muted">Shade: {{ product.shade }}</small>
                    {% endif %}
                </td>
                <td>{{ product.brand.name }}</td>
                <td>{{ product.category.name }}</td>
                <td>{{ product.expiration_date }}</td>
                <td>
                    <span class="status-badge {{ product.expiration_status }}">
                        {{ product.expiration_status|get_status_text }}
                    </span>
                </td>
                <td>
                    {% if product.days_until_expiration < 0 %}
                    <span class="text-danger">Expired {{ product.days_until_expiration|abs }} days ago</span>
                    {% else %}
                    {{ product.days_until_expiration }} days
                    {% endif %}
                </td>
                <td class="table-actions">
                    <div class="action-buttons">
                        <a href="{% url 'myapp:product_detail' product.pk %}" class="btn btn-sm btn-outline-primary" 
                           data-bs-toggle="tooltip" title="View Details">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'myapp:product_edit' product.pk %}" class="btn btn-sm btn-outline-secondary" 
                           data-bs-toggle="tooltip" title="Edit">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{% url 'myapp:product_delete' product.pk %}" class="btn btn-sm btn-outline-danger" 
                           data-bs-toggle="tooltip" title="Delete"
                           onclick="return confirm('Are you sure you want to delete {{ product.name }}?')">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination with filter parameters -->
{% if is_paginated %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
        </li>
        {% endif %}
        
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active">
                <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="empty-state">
    <i class="fas fa-box-open"></i>
    <h3>No Products Found</h3>
    <p class="text-muted">
        {% if current_status or current_category or current_search %}
        No products match your current filters. Try adjusting your search criteria.
        {% else %}
        You haven't added any cosmetics yet. Click the button above to get started.
        {% endif %}
    </p>
    {% if current_status or current_category or current_search %}
    <a href="{% url 'myapp:product_list' %}" class="btn btn-secondary mt-3">
        <i class="fas fa-times me-1"></i> Clear Filters
    </a>
    {% else %}
    <a href="{% url 'myapp:product_add' %}" class="btn btn-primary mt-3">
        <i class="fas fa-plus me-1"></i> Add Your First Product
    </a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// 只保留必要的JavaScript功能
document.addEventListener('DOMContentLoaded', function() {
    // 初始化工具提示
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // 搜索框回车键提交
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('filter-form').submit();
            }
        });
    }
});
</script>
{% endblock %}